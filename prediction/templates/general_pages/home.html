{% extends "shared/base.html" %}


{% block title %}
<title>Disease detection</title>
{% endblock %}

{% block content %}
<!-- Html -->
<div class="container">
    <h1 class="display-4">Classification</h1>
    <form method='post' action = '/disease/predict/not_seg' class='image' enctype="multipart/form-data">
        <span class = 'image__des'></span>
        <input type='file' name= 'file' id= 'input_img'>
        <input type="submit">
    </form>
    <p> Predicted Disease:</p>
    <ul class='predict-result'></ul>
    <div class="pred-img"></div>
    <form action="">
        <input type="text" autocomplete="off" id="command">
        <input type="submit" onclick="sendCommand(event)">
        <ul id="control"></ul>
    </form>
    <h4>TEMPERATURE AND HUMIDITY UPDATE TEST</h4>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.0/socket.io.js"
    integrity="sha512-zpwALZtEUgguEViSrR8yVZpFH0QBBtr9gJ6QUHglri7i+SyUcrr/3o9mfMI12REAGVqMmkwGzkEguFBF7LOpFw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
    // ws initialization
    const socket = io()
    socket.on("connect", ()=>{
        console.log("Websocket connected")
    })
    // 
    const $ =document.querySelector.bind(document)
    const $$ = document.querySelectorAll.bind(document)
    const form = $('form')
    const inputImg = $('#input_img')
    const submitBtn= $("input[type='submit']")
    const predResult = $('.predict-result')
    const predImg = $('.pred-img')
    submitBtn.onclick = function(e){
        e.preventDefault();
        let data = new FormData()
        data.append('file', inputImg.files[0])
        // data = JSON.stringify(data)
        predResult.innerText = '...predicting'
        let srcID ='';
        fetchImage(data).then(result => {
            predResult.innerText = ''
            if(typeof(result) ==="string"){
                predResult.innerText = result
            }
            else {
                console.log(result, typeof(result))
                Object.keys(result).forEach((each)=>{
                    if (each !== 'srcID') {

                        var leafElement = document.createElement('li')
                        leafElement.innerText = `${each} status: ${result[each]}`
                        predResult.appendChild(leafElement)
                    }
                    else {
                        srcID = result["srcID"]
                    }
                })
                
            }
        })
        .then(()=>{
            getImage(srcID).then(result=>{
                console.log(typeof(result), result)
                result.forEach(each =>{
                let imgURL = each.image_url;
                let imgElement = document.createElement('img');
                imgElement.setAttribute('src', imgURL)
                predImg.appendChild(imgElement)
                })
                // result.forEach(each=>console.log('each',each))
            })
        })
    }
    async function fetchImage(data){
        const response = await fetch("/disease/predict", {
            method: "POST",
            body: data,
        })
        return response.json()
    }
    async function getImage(srcID){
        const response = await fetch(`/image/${srcID}`)
        return response.json()
    }

    // for websocket interface
    
    function sendCommand(event){
        var input = document.getElementById("command")
        socket.emit("control", input.value)
        input.value = ''
        event.preventDefault()
    }
    socket.on("envi", data =>{
        console.log(data)
    })
    socket.on("control", (data)=>{
        var ws = document.querySelector("#control")
        var element = document.createElement("li")
        var text = document.createTextNode(data)
        element.appendChild(text)
        ws.appendChild(element)
    })
</script>

{% endblock %}